using System;
using System.Collections.Generic;
using System.IO;
using System.Reflection;
using System.Runtime.Loader;

namespace Scotec.Revit.Loader;

internal class RevitAssemblyLoadContext : AssemblyLoadContext
{{
    private readonly string _pluginRoot;
    private readonly Dictionary<string, string> _assemblyMap;

    public RevitAssemblyLoadContext(string contextName, string pluginRoot) : base(contextName)
    {{
        _pluginRoot = Path.GetFullPath(pluginRoot);
        _assemblyMap = new Dictionary<string, string>(StringComparer.OrdinalIgnoreCase);

        CacheAssemblies();
    }}

    protected override Assembly Load(AssemblyName assemblyName)
    {{
        if (_assemblyMap.TryGetValue(assemblyName.FullName, out var path))
        {{
            return LoadFromAssemblyPath(path);
        }}

        // Let framework assemblies resolve normally
        return null;
    }}

        private void CacheAssemblies()
    {{
        foreach (var file in Directory.EnumerateFiles(_pluginRoot, "*.dll", SearchOption.AllDirectories))
        {{
            try
            {{
                var asmName = AssemblyName.GetAssemblyName(file);

                if (!_assemblyMap.ContainsKey(asmName.FullName))
                {{
                    _assemblyMap[asmName.FullName] = file;
                }}
                else
                {{
                    Console.WriteLine(
                        $"[Warning] Duplicate assembly identity '{{asmName.FullName}}' found at: {{file}}. " +
                        $"Using first occurrence: {{_assemblyMap[asmName.FullName]}}"
                    );
                }}
            }}
            catch (BadImageFormatException)
            {{
                // Not a managed .NET assembly (likely a native DLL) → skip
            }}
            catch (FileLoadException)
            {{
                // The file exists but is not a valid .NET assembly → skip
            }}
        }}
    }}
}}
